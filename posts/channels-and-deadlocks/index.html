<!DOCTYPE html> <html lang="en" > <head> <meta charset="utf-8"> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Channels and Deadlocks in Go with a File crawler | g14a</title> <meta name="generator" content="Jekyll v4.3.3" /> <meta property="og:title" content="Channels and Deadlocks in Go with a File crawler" /> <meta name="author" content="g14a" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Thoughts and Knowledge." /> <meta property="og:description" content="Thoughts and Knowledge." /> <link rel="canonical" href="https://g14a.github.io/posts/channels-and-deadlocks/" /> <meta property="og:url" content="https://g14a.github.io/posts/channels-and-deadlocks/" /> <meta property="og:site_name" content="g14a" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-11-27T14:30:00+05:30" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Channels and Deadlocks in Go with a File crawler" /> <meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"g14a"},"dateModified":"2024-09-11T16:36:56+05:30","datePublished":"2021-11-27T14:30:00+05:30","description":"Thoughts and Knowledge.","headline":"Channels and Deadlocks in Go with a File crawler","mainEntityOfPage":{"@type":"WebPage","@id":"https://g14a.github.io/posts/channels-and-deadlocks/"},"url":"https://g14a.github.io/posts/channels-and-deadlocks/"}</script> <!-- End Jekyll SEO tag --> </head> <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta name="theme" content="Chirpy v2.7.2"> <meta name="google-site-verification" content="Uq5Ws_S7HFCjNgyIIOGXi76bInqos1mAvxiCrJspc8U" /> <!-- Begin Jekyll SEO tag v2.8.0 --> <title>Channels and Deadlocks in Go with a File crawler | g14a</title> <meta name="generator" content="Jekyll v4.3.3" /> <meta property="og:title" content="Channels and Deadlocks in Go with a File crawler" /> <meta name="author" content="g14a" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Thoughts and Knowledge." /> <meta property="og:description" content="Thoughts and Knowledge." /> <link rel="canonical" href="https://g14a.github.io/posts/channels-and-deadlocks/" /> <meta property="og:url" content="https://g14a.github.io/posts/channels-and-deadlocks/" /> <meta property="og:site_name" content="g14a" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2021-11-27T14:30:00+05:30" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Channels and Deadlocks in Go with a File crawler" /> <meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"g14a"},"dateModified":"2024-09-11T16:36:56+05:30","datePublished":"2021-11-27T14:30:00+05:30","description":"Thoughts and Knowledge.","headline":"Channels and Deadlocks in Go with a File crawler","mainEntityOfPage":{"@type":"WebPage","@id":"https://g14a.github.io/posts/channels-and-deadlocks/"},"url":"https://g14a.github.io/posts/channels-and-deadlocks/"}</script> <!-- End Jekyll SEO tag --> <title>Channels and Deadlocks in Go with a File crawler | g14a </title> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --> <link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"> <link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"> <link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"> <link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"> <link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"> <link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"> <link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"> <link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"> <link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"> <link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"> <link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"> <link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"> <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"> <link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"> <link rel="manifest" href="/assets/img/favicons/manifest.json"> <meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'> <meta name="msapplication-TileColor" content="#ffffff"> <meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"> <meta name="theme-color" content="#ffffff"> <!-- Google Fonts --> <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"> <link rel="dns-prefetch" href="https://fonts.gstatic.com"> <!-- GA --> <link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"> <link rel="dns-prefetch" href="https://www.google-analytics.com"> <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"> <link rel="dns-prefetch" href="https://www.googletagmanager.com"> <!-- jsDelivr CDN --> <link rel="preconnect" href="cdn.jsdelivr.net"> <link rel="dns-prefetch" href="cdn.jsdelivr.net"> <!-- Bootstrap --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"> <!-- Font Awesome --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <link rel="preload" href="/assets/css/post.css" as="style"> <link rel="stylesheet" href="/assets/css/post.css"> <link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"> <link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <!-- JavaScripts --> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script async src="/assets/js/post.min.js"></script> <!-- PWA --> <script defer src="/app.js"></script> <!-- GA --> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <!-- Global site tag (gtag.js) - Google Analytics --> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-5XJNKPTFP0"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-5XJNKPTFP0'); }); </script> </head> <body data-spy="scroll" data-target="#toc"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <div id="sidebar" class="d-flex flex-column align-items-end"> <div class="profile-wrapper text-center"> <div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/sample/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a> </div> <div class="site-title mt-3"> <a href="/">g14a</a> </div> <div class="site-subtitle font-italic">Thoughts and Knowledge.</div> </div><!-- .profile-wrapper --> <ul class="w-100"> <!-- home --> <li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a> </li> <!-- the real tabs --> <li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a> </li> <!-- .nav-item --> <li class="nav-item"> <a href="/tabs/opensource/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>OPEN SOURCE</span> </a> </li> <!-- .nav-item --> <li class="nav-item"> <a href="/tabs/projects/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a> </li> <!-- .nav-item --> <li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a> </li> <!-- .nav-item --> <li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a> </li> <!-- .nav-item --> <li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a> </li> <!-- .nav-item --> </ul> <!-- ul.nav.flex-column --> <div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/g14a" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['gowtham.m81197','gmail.com'].join('@')" aria-label="email" class="order-4" > <i class="fas fa-envelope"></i> </a> <a href="https://www.linkedin.com/in/gowtham-munukutla/" aria-label="linkedin" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> </div> <!-- .sidebar-bottom --> </div><!-- #sidebar --> <!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <div id="topbar-wrapper" class="row justify-content-center topbar-down"> <div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Channels and Deadlocks in Go with a File crawler</span> </span><!-- endof #breadcrumb --> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i> <div id="topbar-title"> Post </div> <i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span> </div> </div> <div id="main-wrapper"> <div id="main"> <!-- Refactor the HTML structure. --> <!-- In order to allow a wide table to scroll horizontally, we suround the markdown table with `<div class="table-wrapper">` and `</div>` --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --> <!-- Add attribute 'hide-bullet' to the checkbox list --> <!-- return --> <div class="row"> <div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"> <div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <h1 data-toc-skip>Channels and Deadlocks in Go with a File crawler</h1> <div class="post-meta text-muted d-flex flex-column"> <!-- Published date and author --> <div> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 27, 2021, 2:30 PM +0530" > Nov 27, 2021 <i class="unloaded">2021-11-27T14:30:00+05:30</i> </span> by <span class="author"> g14a </span> </div> <div> <!-- lastmod --> <span> Updated <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 11, 2024, 4:36 PM +0530" > Sep 11 <i class="unloaded">2024-09-11T16:36:56+05:30</i> </span> </span> <!-- read time --> <!-- Calculate the post's reading time, and display the word count in tooltip --> <!-- return element --> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2283 words">12 min</span> <!-- page views --> </div> </div> <!-- .post-meta --> <div class="post-content"> <!-- Using lozad. See: <https://github.com/ApoorvSaxena/lozad.js#usage> --> <p> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://media.giphy.com/media/EbRPam1A4jEWkUokL8/giphy.gif" width="250" height="250" alt="" /> </p> <p>Welcome back! We’ve seen in the earlier sections that channels can be used to improve and control concurrency in Golang. But let’s look at it again with a fresh mind. Let’s unlearn things and re-learn them again.</p> <h2 id="assumptions"><strong>Assumptions</strong></h2> <p>Going forward I assume that you have basic knowledge of Go syntax and how to write Go programs/build them. Even though we’re re-learning things I assume that you haven’t literally hit your head and forgotten basic Golang.</p> <h2 id="creating-channels"><strong>Creating Channels</strong></h2> <p>We create channels by either initializing them or assigning them.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">intChan</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div> <p>or</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">intChan</span> <span class="k">chan</span> <span class="kt">int</span>
<span class="n">intChan</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div> <p>We send data into the channel by using the <code class="language-plaintext highlighter-rouge">&lt;-</code> operator</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="n">intChan</span> <span class="o">&lt;-</span> <span class="m">10</span>
</pre></td></tr></tbody></table></code></div></div> <p>And we receive data using the same operator but like this</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="o">&lt;-</span> <span class="n">intChan</span>
<span class="c">//or</span>
<span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">intChan</span>
</pre></td></tr></tbody></table></code></div></div> <h2 id="lets-write-a-program"><strong>Let’s write a program</strong></h2> <p>We’re just trying to insert an integer into an int channel and trying to get it out of it. And then print it. This should work right?</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
<span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>

<span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="n">ic</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div> <p>This throws out the famous deadlock error!</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>fatal error: all goroutines are asleep - deadlock!

goroutine 1 <span class="o">[</span>chan send]:
main.main<span class="o">()</span>
        /Users/g14a/main.go:12 +0x37
<span class="nb">exit </span>status 2
</pre></td></tr></tbody></table></code></div></div> <p>Someone on the internet compared a channel to a portal. And I just never forget that. If something goes inside a portal, it should be able to exit the portal simultaneously. Not before or after, but exactly at the same time.</p> <p>So for two things to happen at the time, we need two functions running at the same time. Which can be achieved by nothing but goroutines.</p> <p>The program throws the deadlock error in the following cases:</p> <ul> <li>When data is going into it, but not exiting it.</li> <li>When data is not going into it, but the program tries to extract data from it.</li> <li>When data is going in and coming out, but both are happening at different times and are not in sync.</li> </ul> <p>So now let’s change our code to</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
<span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>

<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="p">}()</span>
<span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="n">ic</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div> <p>Now it prints out 10! Voila!</p> <p>Have you tried this variant though?</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
<span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">)</span>

<span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span> <span class="n">ic</span>

<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">10</span>
<span class="p">}()</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></div></div> <p>Spoiler alert! It breaks. Figure it out. Nah, just kidding. It’s because line 4 is a blocking operation until it gets a value on the channel. So line 6 never gets executed in the first place raising a deadlock again!</p> <h2 id="buffered-channels"><strong>Buffered Channels</strong></h2> <p>We’ve seen the scenario where the program throws a deadlock error. So let’s try the following.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>

    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">1</span>
    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">2</span>

    <span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ic</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>Wait a second! How come this prints <code class="language-plaintext highlighter-rouge">1</code>? It’s because we specified the channel length to be <code class="language-plaintext highlighter-rouge">2</code> in line 3. We call these channels as <code class="language-plaintext highlighter-rouge">Buffered Channels</code>. In the first scenario we haven’t specified a length. So the channel doesn’t store any values if there’s no one to receive it from the other end. But here it can store a maximum of two values even without a receiver.</p> <p>What if want to reproduce the deadlock error even with buffered channels? Is there a way? Yup, there’s more than one way.</p> <ul> <li>Pushing more data into the channel breaks the program</li> <li>Retrieving more data than what’s present in the channel also breaks.</li> </ul> <p>Let’s have fun with this.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>

    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">1</span>
    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">2</span>
    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">3</span>
    <span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ic</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>The channel length is 2, but you’re sending 3 values into it. Nope. Breaks!</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">ic</span> <span class="k">chan</span> <span class="kt">int</span>
    <span class="n">ic</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int</span><span class="p">,</span> <span class="m">2</span><span class="p">)</span>

    <span class="n">ic</span> <span class="o">&lt;-</span> <span class="m">1</span>

    <span class="n">a</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ic</span>
    <span class="n">b</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">ic</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>You’ve sent only one value into it but you’re trying to extract two values from it? Straight to jail! How dare ya?</p> <p>So we can casually tell the difference between buffered and unbuffered channels.</p> <div class="table-wrapper"><table> <thead> <tr> <th>Unbuffered</th> <th>Buffered</th> </tr> </thead> <tbody> <tr> <td>Don’t underdo things.</td> <td>Don’t overdo things.</td> </tr> </tbody> </table></div> <h2 id="file-crawler"><strong>File Crawler</strong></h2> <p>Let’s write a file crawler which counts the number of files(recursively in sub directories as well) and gives us the disk usage of all of them.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre></td><td class="rouge-code"><pre><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"flag"</span>
	<span class="s">"fmt"</span>
	<span class="s">"io/ioutil"</span>
	<span class="s">"os"</span>
	<span class="s">"path/filepath"</span>
	<span class="s">"time"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">flag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>

    <span class="n">roots</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">Args</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"."</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

    <span class="k">var</span> <span class="n">totalFiles</span><span class="p">,</span> <span class="n">totalBytes</span> <span class="kt">int64</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">root</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">roots</span> <span class="p">{</span>
        <span class="n">files</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">:=</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
        <span class="n">totalFiles</span> <span class="o">+=</span> <span class="n">files</span>
        <span class="n">totalBytes</span> <span class="o">+=</span> <span class="n">bytes</span>
    <span class="p">}</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"total time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
    <span class="n">printUsage</span><span class="p">(</span><span class="n">totalFiles</span><span class="p">,</span> <span class="n">totalBytes</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">printUsage</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">bytes</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%d files %.1f GB</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="kt">float64</span><span class="p">(</span><span class="n">bytes</span><span class="p">)</span><span class="o">/</span><span class="m">1e9</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="n">noOfFiles</span><span class="p">,</span> <span class="n">totalSize</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">getEntries</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">IsDir</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">subDir</span> <span class="o">:=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span>
            <span class="n">files</span><span class="p">,</span> <span class="n">bytes</span> <span class="o">:=</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">subDir</span><span class="p">)</span>
            <span class="n">noOfFiles</span> <span class="o">+=</span> <span class="n">files</span>
            <span class="n">totalSize</span> <span class="o">+=</span> <span class="n">bytes</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">noOfFiles</span><span class="o">++</span>
            <span class="n">e</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">entry</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
				<span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="p">}</span>
            <span class="n">totalSize</span> <span class="o">+=</span> <span class="n">e</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getEntries</span><span class="p">(</span><span class="n">dir</span> <span class="kt">string</span><span class="p">)</span> <span class="p">[]</span><span class="n">os</span><span class="o">.</span><span class="n">DirEntry</span> <span class="p">{</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadDir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">entries</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>Now the above program doesn’t implement concurrency, its just plain functions and single threaded. The code is straight forward.</p> <ul> <li>We take one of more directories.</li> <li>We loop on each one of them.</li> <li>Get entries of each directory, recursively call the <code class="language-plaintext highlighter-rouge">walkDirectory</code> function if an entry is a directory, else we interpret it as a file and increase the count and size.</li> </ul> <p>Let’s test our program on a large directory like the <a href="https://github.com/torvalds/linux">Linux operating system source tree</a>.</p> <p>The source contains 70k files and a total size of 5GB.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>go run two-sum/main.go ~/linux
total <span class="nb">time</span>:  2.827069181s
74319 files 5.0 GB
</pre></td></tr></tbody></table></code></div></div> <p>Huh! 2 seconds isn’t that bad for almost 75k files. But it looks like we can optimise it. The only area of optimisation is we can make each directory operation independent of another and this should get a little better.</p> <h2 id="optimisation"><strong>Optimisation</strong></h2> <p>Let’s refactor our <code class="language-plaintext highlighter-rouge">walkDirectory</code> function and see how it looks.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="n">wg</span> <span class="o">*</span><span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span><span class="p">,</span> <span class="n">fileSize</span> <span class="k">chan</span><span class="o">&lt;-</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">defer</span> <span class="n">wg</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">getEntries</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="n">entry</span><span class="o">.</span><span class="n">IsDir</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
                <span class="n">subdir</span> <span class="o">:=</span> <span class="n">filepath</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span> <span class="n">entry</span><span class="o">.</span><span class="n">Name</span><span class="p">())</span>
                <span class="k">go</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">subdir</span><span class="p">,</span> <span class="n">wg</span><span class="p">,</span> <span class="n">fileSize</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">info</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">entry</span><span class="o">.</span><span class="n">Info</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
                    <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
                <span class="p">}</span>
                <span class="n">fileSize</span> <span class="o">&lt;-</span> <span class="n">info</span><span class="o">.</span><span class="n">Size</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>We will be calling this function as a goroutine in the main function so we need to keep track of all of them. A <code class="language-plaintext highlighter-rouge">sync.WaitGroup</code> exists just for that purpose. So we add a <code class="language-plaintext highlighter-rouge">defer wg.Done()</code> in the beginning in case we forget to decrement our counters in the end.</p> <p>In our serial program we had a counter and it was incremented as and when we encountered a file. But here, we send each file info into a channel of type <code class="language-plaintext highlighter-rouge">int</code> on line 13. The reason we did this is simple. Every single value that goes into the channel means a file has been come across, because we don’t calculate the size of the same file more than once.</p> <p>I assume we remember the syntax of a write-only channel which is <code class="language-plaintext highlighter-rouge">chan&lt;- int64</code></p> <p>Soon our main function becomes this.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">roots</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">Args</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"."</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

    <span class="n">fileSizes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int64</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">root</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">roots</span> <span class="p">{</span>
        <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wg</span><span class="p">,</span> <span class="n">fileSizes</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">fileSizes</span><span class="p">)</span>

    <span class="k">var</span> <span class="n">nFiles</span><span class="p">,</span> <span class="n">nBytes</span> <span class="kt">int64</span>

    <span class="k">for</span> <span class="n">size</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">fileSizes</span> <span class="p">{</span>
        <span class="n">nFiles</span><span class="o">++</span>
        <span class="n">nBytes</span> <span class="o">+=</span> <span class="n">size</span>
    <span class="p">}</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"total time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
    <span class="n">printUsage</span><span class="p">(</span><span class="n">nFiles</span><span class="p">,</span> <span class="n">nBytes</span><span class="p">)</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>We wait for all the goroutines to end at line 18 and we close the channel once all the goroutines have completed their work. Now let’s see the output of this.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>panic: open /Users/g14a/linux/arch/arc/boot/dts: too many open files

goroutine 1142 <span class="o">[</span>running]:
main.getEntries<span class="o">(</span>...<span class="o">)</span>
	/Users/g14a/main.go:78
main.walkDirectory<span class="o">({</span>0xc000672b70, 0x23<span class="o">}</span>, 0xc0000141c0, 0xc0000240c0, 0xc000024120<span class="o">)</span>
	/Users/g14a/main.go:58 +0x299
created by main.walkDirectory
	/Users/g14a/main.go:62 +0x225
<span class="nb">exit </span>status 2
</pre></td></tr></tbody></table></code></div></div> <p> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://media.giphy.com/media/e1s8C0YnnfjlRf7mEr/giphy.gif" width="430" height="250" alt="" /> </p> <p>The reason this happens in we’re concurrently accessing a lot of files which was past our <code class="language-plaintext highlighter-rouge">open file descriptor limit</code>. So we don’t want to do that. Neither do we want to increase our maximum limit to really 75k files.</p> <p>We only want our program to access a certain number of files at a time. So we change our <code class="language-plaintext highlighter-rouge">getEntries</code> function because that’s where all the reading is happening.</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">getEntries</span><span class="p">(</span><span class="n">dir</span> <span class="kt">string</span><span class="p">,</span> <span class="n">sema</span> <span class="k">chan</span> <span class="k">struct</span><span class="p">{})</span> <span class="p">[]</span><span class="n">os</span><span class="o">.</span><span class="n">DirEntry</span> <span class="p">{</span>
    <span class="n">sema</span> <span class="o">&lt;-</span> <span class="k">struct</span><span class="p">{}{}</span>
    <span class="k">defer</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="o">&lt;-</span><span class="n">sema</span> <span class="p">}</span> <span class="p">()</span>
    <span class="n">entries</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadDir</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">entries</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></div></div> <p>What we’re doing here is basically send in an empty struct to a channel, do our file operation and then pop the empty struct via defer at the end. Remember semaphores?!</p> <p>Now we want to keep this configurable at run time so let’s add a command line flag called <code class="language-plaintext highlighter-rouge">-p</code> to get this value via stdin.</p> <p>The main function becomes:</p> <div class="language-go highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>

    <span class="n">flag</span><span class="o">.</span><span class="n">IntVar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">maxConcurrency</span><span class="p">,</span> <span class="s">"p"</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">flag</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>

    <span class="n">roots</span> <span class="o">:=</span> <span class="n">flag</span><span class="o">.</span><span class="n">Args</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
        <span class="n">roots</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"."</span><span class="p">}</span>
    <span class="p">}</span>

    <span class="n">now</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">Now</span><span class="p">()</span>

    <span class="n">fileSizes</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">int64</span><span class="p">)</span>
    <span class="k">var</span> <span class="n">wg</span> <span class="n">sync</span><span class="o">.</span><span class="n">WaitGroup</span>

    <span class="k">var</span> <span class="n">sema</span> <span class="o">=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="k">struct</span><span class="p">{},</span> <span class="n">maxConcurrency</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">root</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">roots</span> <span class="p">{</span>
        <span class="n">wg</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
        <span class="k">go</span> <span class="n">walkDirectory</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wg</span><span class="p">,</span> <span class="n">fileSizes</span><span class="p">,</span> <span class="n">sema</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">wg</span><span class="o">.</span><span class="n">Wait</span><span class="p">()</span>
    <span class="nb">close</span><span class="p">(</span><span class="n">fileSizes</span><span class="p">)</span>

    <span class="k">var</span> <span class="n">nFiles</span><span class="p">,</span> <span class="n">nBytes</span> <span class="kt">int64</span>

    <span class="k">for</span> <span class="n">size</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">fileSizes</span> <span class="p">{</span>
        <span class="n">nFiles</span><span class="o">++</span>
        <span class="n">nBytes</span> <span class="o">+=</span> <span class="n">size</span>
    <span class="p">}</span>

    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"total time: "</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">Since</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
    <span class="n">printUsage</span><span class="p">(</span><span class="n">nFiles</span><span class="p">,</span> <span class="n">nBytes</span><span class="p">)</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></div></div> <p><span style="color:#FF02c4"><b>The reason we added a size to the channel on <code class="language-plaintext highlighter-rouge">line 16</code> is to allow <code class="language-plaintext highlighter-rouge">maxConcurrency</code> number of files to be access by goroutines. It is also the reason why we did not pop empty structs from the channel in the <code class="language-plaintext highlighter-rouge">getEntries</code> function in a goroutine. Remember the portal example. Buffered channels don’t act like portals. Only non-buffered channels do.</b></span></p> <p>Let’s run this program by passing a value of 20 to the <code class="language-plaintext highlighter-rouge">-p</code> flag.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>go run main.go <span class="nt">-p</span> 20 ~/linux
fatal error: all goroutines are asleep - deadlock!

goroutine 1 <span class="o">[</span>semacquire]:
sync.runtime_Semacquire<span class="o">(</span>0x0<span class="o">)</span>
	/usr/local/go/src/runtime/sema.go:56 +0x25
sync.<span class="o">(</span><span class="k">*</span>WaitGroup<span class="o">)</span>.Wait<span class="o">(</span>0xc0000261e0<span class="o">)</span>
	/usr/local/go/src/sync/waitgroup.go:130 +0x71
main.main<span class="o">()</span>
	/Users/g14a/main.go:37 +0x177

goroutine 6 <span class="o">[</span>chan send]:
main.walkDirectory<span class="o">({</span>0x7ff7bfeff418, 0x11<span class="o">}</span>, 0xc0000141c0, 0xc0000240c0, 0xc000024120<span class="o">)</span>
	/Users/g14a/main.go:68 +0x25c
created by main.main
	/Users/g14a/main.go:33 +0x35f
<span class="nb">exit </span>status 2
</pre></td></tr></tbody></table></code></div></div> <p>Huh! Any idea why this is happening?</p> <p>If we look at our <code class="language-plaintext highlighter-rouge">fileSizes</code> channel, we know its a non-buffered channel. Our waitgroup on line 23 expects all goroutines to continue and move on. But our non-buffered channel is a portal. For the <code class="language-plaintext highlighter-rouge">walkDirectory</code> goroutine to move on, it needs someone taking values out of the <code class="language-plaintext highlighter-rouge">fileSizes</code> channel. But we’re reading from the channel after we <code class="language-plaintext highlighter-rouge">wg.Wait()</code> and <code class="language-plaintext highlighter-rouge">close(fileSizes)</code></p> <p>Two things are happening here:</p> <ul> <li>The goroutine doesn’t move on to the next directory because channel is never read.</li> <li>The values from channel are never read since the goroutine doesn’t move on and decrement its counter(which is basically what <code class="language-plaintext highlighter-rouge">wg.Wait()</code> wants).</li> </ul> <p>So we get a deadlock situation.</p> <p>We just need to put the <code class="language-plaintext highlighter-rouge">wait</code> and <code class="language-plaintext highlighter-rouge">close</code> in a goroutine and our job is done.</p> <p>Let’s see how our program performs with <code class="language-plaintext highlighter-rouge">-p</code> as 1.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>go build <span class="nt">-o</span> parallel main.go
<span class="nv">$ </span>./parallel <span class="nt">-p</span> 1 ~/linux                         
total <span class="nb">time</span>:  416.093619ms
74319 files 5.0 GB
</pre></td></tr></tbody></table></code></div></div> <p>Our serial version took 2.8 seconds. The parallel version is approximately 7 times faster already. But let’s look at what happens when we start increasing the value of <code class="language-plaintext highlighter-rouge">-p</code>.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>./parallel <span class="nt">-p</span> 2 ~/linux 
total <span class="nb">time</span>:  268.323046ms
74319 files 5.0 GB
</pre></td></tr></tbody></table></code></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>./parallel <span class="nt">-p</span> 3 ~/linux
total <span class="nb">time</span>:  201.106361ms
74319 files 5.0 GB
</pre></td></tr></tbody></table></code></div></div> <div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>./parallel <span class="nt">-p</span> 4 ~/linux 
total <span class="nb">time</span>:  177.577326ms
74319 files 5.0 GB
</pre></td></tr></tbody></table></code></div></div> <p>We made it around 16 times faster than the serial version!</p> <p> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://media.giphy.com/media/l0amJzVHIAfl7jMDos/giphy.gif" width="430" height="380" alt="" /> <em>By now you can tell that I'm an Office fan.</em> </p> <h2 id="conclusion"><strong>Conclusion</strong></h2> <p>Pat yourself on the back, its been a hell of a ride!</p> <p>But at some point the performance gets saturated. I’m going to leave that to you to play around and get the maximum performance on your machine.</p> <p>You can have a look at my final program here - <a href="https://gist.github.com/g14a/277337b834f3568a4c963c92d4db4c11">Github Gist</a></p> <p>Let me know if I can improve better or any areas where I have gone wrong.</p> <p>Please reach out to me via email(or any social media linked down below) if you think I haven’t covered something which you consider important.</p> <p>Thank you 😁</p> </div> <div class="post-tail-wrapper text-muted"> <!-- categories --> <div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/tutorials/'>tutorials</a> </div> <!-- tags --> <div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/golang/" class="post-tag no-text-decoration" >golang</a> <a href="/tags/channels/" class="post-tag no-text-decoration" >channels</a> <a href="/tags/concurrency/" class="post-tag no-text-decoration" >concurrency</a> <a href="/tags/exercise/" class="post-tag no-text-decoration" >exercise</a> <a href="/tags/performance/" class="post-tag no-text-decoration" >performance</a> </div> <div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"> <div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author. </div> <!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --> <div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Channels and Deadlocks in Go with a File crawler - g14a&url=https://g14a.github.io/posts/channels-and-deadlocks/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Channels and Deadlocks in Go with a File crawler - g14a&u=https://g14a.github.io/posts/channels-and-deadlocks/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Channels and Deadlocks in Go with a File crawler - g14a&url=https://g14a.github.io/posts/channels-and-deadlocks/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span> </div> </div><!-- .post-tail-bottom --> </div><!-- div.post-tail --> </div> <!-- .post --> </div> <!-- #post-wrapper --> <!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"> <div class="access"> <div id="access-lastmod" class="post"> <span>Recent Update</span> <ul class="post-content pl-0 pb-1 ml-1 mt-2"> <li><a href="/posts/interfaces/">How I learnt Go Interfaces</a></li> <li><a href="/posts/using-Go-Channels-p1/">Using Go Channels - Part 1 - Introduction to Channels</a></li> <li><a href="/posts/using-Go-Channels-p3/">Using Go Channels - Part 3 - Read/Write Channels & Select</a></li> <li><a href="/posts/using-Go-Channels-p4/">Using Go Channels - Part 4 - Image Processing with Channels</a></li> <li><a href="/posts/using-Go-Channels-p5/">Using Go Channels - Part 4 - Image Processing with Channels - Part 2</a></li> </ul> </div> <!-- #access-lastmod --> <div id="access-tags"> <span>Trending Tags</span> <div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/channels/">channels</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/exercise/">exercise</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cache/">cache</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/cobra/">cobra</a> <a class="post-tag" href="/tags/databases/">databases</a> <a class="post-tag" href="/tags/heroku/">heroku</a> </div> </div> </div> <!-- .access --> <div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span> <nav id="toc" data-toggle="toc"></nav> </div> </div> <!-- #panel-wrapper --> </div> <!-- .row --> <div class="row"> <div class="col-12 col-lg-11 col-xl-8"> <div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --> <!-- The total size of related posts --> <!-- An random integer that bigger than 0 --> <!-- Equals to TAG_SCORE / {max_categories_hierarchy} --> <!-- Fill with the other newlest posts --> <div id="related-posts" class="mt-5 mb-2 mb-sm-4"> <h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3> <div class="card-deck mb-4"> <div class="card"> <a href="/posts/using-Go-Channels-p4/"> <div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Apr 15, 2021 <i class="unloaded">2021-04-15T18:30:00+05:30</i> </span> <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Using Go Channels - Part 4 - Image Processing with Channels</h3> <div class="text-muted small"> <p> A Tiny Recap In the earlier section Part - 3 , we have learnt: What read and write specific channels are How we use select in the context of goroutines Finally, how we apply timeouts in se... </p> </div> </div> </a> </div> <div class="card"> <a href="/posts/using-Go-Channels-p5/"> <div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Apr 16, 2021 <i class="unloaded">2021-04-16T14:30:00+05:30</i> </span> <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Using Go Channels - Part 4 - Image Processing with Channels - Part 2</h3> <div class="text-muted small"> <p> A Tiny Recap In the earlier section Part - 4, we have seen the serial and parallel versions of our image processing program. Now let us see if we can make our parallel version even better. ... </p> </div> </div> </a> </div> <div class="card"> <a href="/posts/using-Go-Channels-p1/"> <div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Apr 6, 2021 <i class="unloaded">2021-04-06T13:23:00+05:30</i> </span> <h3 class="pt-0 mt-1 mb-3" data-toc-skip>Using Go Channels - Part 1 - Introduction to Channels</h3> <div class="text-muted small"> <p> Introduction We know that Goroutines are independently executing user space threads. Imagine an office workspace where ten employees are working towards a customer satisfying goal. These ten empl... </p> </div> </div> </a> </div> </div> <!-- .card-deck --> </div> <!-- #related-posts --> <!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <div class="post-navigation d-flex justify-content-between"> <a href="/posts/Testing-Cobra-Subcommands/" class="btn btn-outline-primary"> <p>Testing Cobra Subcommands</p> </a> <a href="/posts/lru-cache/" class="btn btn-outline-primary"> <p>LRU Cache Using Go in under 100 lines!</p> </a> </div> </div> <!-- #post-extend-wrapper --> </div> <!-- .col-* --> </div> <!-- .row --> <!-- image lazy load: https://github.com/ApoorvSaxena/lozad.js --> <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <footer class="d-flex w-100 justify-content-center"> <div class="d-flex justify-content-between align-items-center"> <div class="footer-left"> <p class="mb-0"> © 2024 <a href="https://twitter.com/username">g14a</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span> </p> </div> <div class="footer-right"> <p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme. </p> </div> </div> <!-- div.d-flex --> </footer> </div> <!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <div id="search-result-wrapper" class="d-flex justify-content-center unloaded"> <div class="col-12 col-xl-11 post-content"> <div id="search-hints"> <h4 class="text-muted mb-4">Trending Tags</h4> <a class="post-tag" href="/tags/golang/">golang</a> <a class="post-tag" href="/tags/channels/">channels</a> <a class="post-tag" href="/tags/concurrency/">concurrency</a> <a class="post-tag" href="/tags/exercise/">exercise</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cache/">cache</a> <a class="post-tag" href="/tags/cli/">cli</a> <a class="post-tag" href="/tags/cobra/">cobra</a> <a class="post-tag" href="/tags/databases/">databases</a> <a class="post-tag" href="/tags/heroku/">heroku</a> </div> <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div> </div> </div> </div> <!-- #main-wrapper --> <div id="mask"></div> <a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://g14a.github.io{url}">{title}</a> <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> <div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div> <div><i class="fa fa-tag fa-fw"></i>{tags}</div> </div> <p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script> </body> </html>
